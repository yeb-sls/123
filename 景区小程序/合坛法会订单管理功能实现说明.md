# 合坛法会订单管理功能实现说明

## 功能概述

已成功实现合坛法会订单的完整管理功能，包括查询、导出、确认和备注等核心功能。

## 已实现功能

### 1. 订单查询功能
- **页面位置**: `pages/admin/joint/orders.vue`
- **功能描述**: 查看所有合坛法会订单，按创建时间倒序排列
- **显示信息**:
  - 订单基本信息（订单号、状态、项目名称、法会日期等）
  - 报名者信息
  - 代办物品信息
  - 收件信息
  - 操作日志
  - 管理员备注

### 2. 订单导出功能
- **云函数**: `exportJointOrders`
- **功能描述**: 导出所有订单数据为CSV格式
- **导出字段**:
  - 订单号、状态、项目名称、法会日期
  - 报名人数、总费用
  - 收件人信息（姓名、电话、地址）
  - 创建时间、确认时间、确认人
  - 备注内容

### 3. 订单确认功能
- **操作按钮**: "此合坛法会已确认"
- **云函数**: `updateJointOrderStatus`
- **记录信息**:
  - 操作人：自动获取当前管理员信息
  - 操作时间：系统自动记录
  - 操作日志：记录到 `joint_order_logs` 表
  - 订单状态：更新为"已确认"

### 4. 订单备注功能
- **操作按钮**: "添加备注"
- **云函数**: `addJointOrderRemark`
- **记录信息**:
  - 备注内容：管理员输入
  - 操作人：自动获取当前管理员信息
  - 操作时间：系统自动记录
  - 保存位置：`joint_order_remarks` 表和订单的 `adminRemarks` 数组

### 5. 支付成功自动提醒
- **云函数**: `notifyAdminOnPayment`
- **触发时机**: 订单支付成功后自动调用
- **提醒内容**:
  - 订单号、法会项目、报名人数、支付金额
  - 自动创建通知记录到 `admin_notifications` 表
  - 订单状态自动更新为"待确认"

### 6. 管理员通知系统
- **页面位置**: `pages/admin/notifications.vue`
- **功能描述**: 集中管理所有系统通知
- **功能特性**:
  - 显示未读/已读状态
  - 支持标记单个通知为已读
  - 支持标记所有通知为已读
  - 重要通知高亮显示
  - 支持跳转到相关订单

### 7. 通知数量显示
- **位置**: 管理首页系统通知模块
- **功能**: 实时显示未读通知数量
- **云函数**: `getUnreadNotificationCount`

## 数据库表结构

### 1. joint_orders (合坛法会订单表)
```javascript
{
  _id: "订单ID",
  status: "订单状态", // 待支付、已支付、待确认、已确认、已完成、已取消
  projectName: "项目名称",
  fahuiDate: "法会日期",
  applicants: [], // 报名者信息数组
  totalCost: 0, // 总费用
  receiver: {}, // 收件信息
  createTime: "创建时间",
  confirmTime: "确认时间",
  confirmBy: "确认人",
  adminRemarks: [], // 管理员备注数组
  logs: [], // 操作日志数组
  update_time: "更新时间"
}
```

### 2. joint_order_logs (订单操作日志表)
```javascript
{
  order_id: "订单ID",
  action: "操作描述",
  operator: "操作人",
  time: "操作时间"
}
```

### 3. joint_order_remarks (订单备注表)
```javascript
{
  order_id: "订单ID",
  content: "备注内容",
  operator: "操作人",
  time: "操作时间"
}
```

### 4. admin_notifications (管理员通知表)
```javascript
{
  type: "通知类型", // joint_order_paid
  title: "通知标题",
  content: "通知内容",
  order_id: "相关订单ID",
  is_read: false, // 是否已读
  create_time: "创建时间",
  priority: "优先级" // high
}
```

## 云函数列表

1. **getJointOrders** - 获取合坛法会订单列表
2. **exportJointOrders** - 导出订单数据
3. **updateJointOrderStatus** - 更新订单状态
4. **addJointOrderRemark** - 添加订单备注
5. **notifyAdminOnPayment** - 支付成功通知
6. **getAdminNotifications** - 获取管理员通知
7. **markNotificationAsRead** - 标记通知为已读
8. **markAllNotificationsAsRead** - 标记所有通知为已读
9. **getUnreadNotificationCount** - 获取未读通知数量

## 使用流程

### 1. 订单支付成功流程
1. 用户完成支付
2. 系统自动调用 `notifyAdminOnPayment` 云函数
3. 创建管理员通知记录
4. 订单状态更新为"待确认"
5. 管理首页显示未读通知数量

### 2. 订单确认流程
1. 管理员查看通知或直接进入订单管理页面
2. 点击"此合坛法会已确认"按钮
3. 系统记录操作人和操作时间
4. 订单状态更新为"已确认"
5. 生成操作日志

### 3. 添加备注流程
1. 管理员点击"添加备注"按钮
2. 在弹出的对话框中输入备注内容
3. 系统记录操作人和操作时间
4. 备注保存到数据库
5. 在订单详情中显示备注历史

### 4. 导出订单流程
1. 管理员点击"导出订单"按钮
2. 系统调用导出云函数获取所有订单数据
3. 生成CSV格式数据
4. 复制到剪贴板供用户粘贴到Excel

## 技术特点

1. **自动化**: 支付成功后自动推送提醒，无需手动操作
2. **完整性**: 记录所有操作的操作人和操作时间
3. **可追溯**: 完整的操作日志和备注历史
4. **实时性**: 未读通知数量实时更新
5. **用户友好**: 直观的界面设计和操作流程

## 注意事项

1. 所有云函数需要上传到云端才能正常使用
2. 管理员信息需要正确存储在本地存储中
3. 数据库表需要提前创建好相应的集合
4. 建议定期清理过期的通知记录以保持系统性能 