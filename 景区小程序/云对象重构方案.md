# 云对象重构方案

## 问题分析

当前项目有大量云函数，导致阿里云服务空间云函数数量已达上限。使用云对象可以大幅减少云函数数量，1个云对象可以包含多个接口。

## 云对象 vs 云函数对比

| 特性 | 云函数 | 云对象 |
|------|--------|--------|
| 接口数量 | 1个云函数 = 1个接口 | 1个云对象 = N个接口 |
| 管理复杂度 | 高（需要管理大量文件） | 低（集中管理） |
| 代码复用 | 困难 | 容易（共享方法和数据） |
| 部署效率 | 低（需要逐个部署） | 高（一次部署多个接口） |
| 维护成本 | 高 | 低 |

## 重构方案

### 1. 合坛法会管理云对象

#### 创建 `joint-management` 云对象

**文件结构：**
```
uniCloud-aliyun/cloudfunctions/joint-management/
├── index.obj.js
└── package.json
```

**功能整合：**
- 项目管理：`getProjects`, `addProject`, `updateProject`, `deleteProject`
- 订单管理：`getOrders`, `updateOrderStatus`, `addOrderRemark`, `exportOrders`
- 物品管理：`getGoods`, `addGood`, `updateGood`, `deleteGood`, `getGoodsConfig`, `updateGoodsConfig`
- 收件管理：`getReceivers`, `addReceiver`, `updateReceiver`, `deleteReceiver`, `getReceiverConfig`, `updateReceiverConfig`
- 配置管理：`getBanners`, `addBanner`, `updateBanner`, `deleteBanner`, `getIntros`, `addIntro`, `updateIntro`, `deleteIntro`

**预计减少云函数数量：** 25个 → 1个

### 2. 通知系统云对象

#### 创建 `notification-system` 云对象

**功能整合：**
- `getUnreadCount`
- `getNotifications`
- `markAsRead`
- `markAllAsRead`
- `createNotification`

**预计减少云函数数量：** 5个 → 1个

### 3. 专场法会管理云对象

#### 创建 `fahui-management` 云对象

**功能整合：**
- 项目管理：`getProjects`, `addProject`, `updateProject`, `deleteProject`
- 订单管理：`getOrders`, `updateOrderStatus`, `addOrderRemark`
- 配置管理：`getConfigs`, `updateConfig`, `getBanners`, `addBanner`, `updateBanner`, `deleteBanner`
- 收件管理：`getReceivers`, `addReceiver`, `updateReceiver`, `deleteReceiver`

**预计减少云函数数量：** 20个 → 1个

### 4. 通用管理云对象

#### 创建 `common-management` 云对象

**功能整合：**
- 首页管理：`getHomeBanners`, `addHomeBanner`, `updateHomeBanner`, `deleteHomeBanner`
- 导航管理：`getHomeNavs`, `addHomeNav`, `updateHomeNav`, `deleteHomeNav`
- 介绍管理：`getHomeIntros`, `addHomeIntro`, `updateHomeIntro`, `deleteHomeIntro`
- 其他功能：`getLightItems`, `getHallItems`, `getDelegateGoods`

**预计减少云函数数量：** 15个 → 1个

## 具体实现示例

### 合坛法会管理云对象实现

```javascript
// uniCloud-aliyun/cloudfunctions/joint-management/index.obj.js

const db = uniCloud.database()

module.exports = {
  // 项目管理
  async getProjects() {
    try {
      const result = await db.collection('joint_projects').get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async addProject(params) {
    try {
      const result = await db.collection('joint_projects').add({
        ...params,
        create_time: new Date()
      })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateProject(params) {
    try {
      const { _id, ...updateData } = params
      const result = await db.collection('joint_projects')
        .doc(_id)
        .update({
          ...updateData,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async deleteProject(params) {
    try {
      const result = await db.collection('joint_projects')
        .doc(params._id)
        .remove()
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  // 订单管理
  async getOrders() {
    try {
      const result = await db.collection('joint_orders')
        .orderBy('createTime', 'desc')
        .get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateOrderStatus(params) {
    try {
      const { orderId, status, action, operator } = params
      const updateData = {
        status,
        update_time: new Date()
      }
      
      if (status === '已确认') {
        updateData.confirmBy = operator || '管理员'
        updateData.confirmTime = new Date()
      }
      
      const result = await db.collection('joint_orders')
        .doc(orderId)
        .update(updateData)
      
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async addOrderRemark(params) {
    try {
      const { orderId, content, operator } = params
      const remark = {
        content,
        operator: operator || '管理员',
        time: new Date()
      }
      
      const result = await db.collection('joint_orders')
        .doc(orderId)
        .update({
          adminRemarks: db.command.push(remark),
          update_time: new Date()
        })
      
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async exportOrders() {
    try {
      const result = await db.collection('joint_orders')
        .orderBy('createTime', 'desc')
        .get()
      
      const data = result.data.map(order => ({
        _id: order._id,
        status: order.status,
        projectName: order.projectName || order.project_name,
        fahuiDate: order.fahuiDate || order.fahui_date,
        applicants: order.applicants || [],
        totalCost: order.totalCost || order.total_fee || 0,
        receiver: order.receiver || null,
        createTime: order.createTime || order.create_time,
        confirmTime: order.confirmTime || order.confirm_time,
        confirmBy: order.confirmBy || order.confirm_by,
        adminRemarks: order.adminRemarks || []
      }))
      
      return { success: true, data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  // 物品管理
  async getGoods() {
    try {
      const result = await db.collection('joint_goods').get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async addGood(params) {
    try {
      const result = await db.collection('joint_goods').add({
        ...params,
        create_time: new Date()
      })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateGood(params) {
    try {
      const { _id, ...updateData } = params
      const result = await db.collection('joint_goods')
        .doc(_id)
        .update({
          ...updateData,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async deleteGood(params) {
    try {
      const result = await db.collection('joint_goods')
        .doc(params._id)
        .remove()
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async getGoodsConfig() {
    try {
      const result = await db.collection('joint_goods_config').get()
      return { success: true, data: result.data[0] || null }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateGoodsConfig(params) {
    try {
      const result = await db.collection('joint_goods_config')
        .doc(params._id)
        .update({
          ...params,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  // 收件管理
  async getReceivers() {
    try {
      const result = await db.collection('joint_receivers').get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async addReceiver(params) {
    try {
      const result = await db.collection('joint_receivers').add({
        ...params,
        create_time: new Date()
      })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateReceiver(params) {
    try {
      const { _id, ...updateData } = params
      const result = await db.collection('joint_receivers')
        .doc(_id)
        .update({
          ...updateData,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async deleteReceiver(params) {
    try {
      const result = await db.collection('joint_receivers')
        .doc(params._id)
        .remove()
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async getReceiverConfig() {
    try {
      const result = await db.collection('joint_receiver_config').get()
      return { success: true, data: result.data[0] || null }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateReceiverConfig(params) {
    try {
      const result = await db.collection('joint_receiver_config')
        .doc(params._id)
        .update({
          ...params,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  // 配置管理
  async getBanners() {
    try {
      const result = await db.collection('joint_banners')
        .orderBy('order', 'asc')
        .get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async addBanner(params) {
    try {
      const result = await db.collection('joint_banners').add({
        ...params,
        create_time: new Date()
      })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateBanner(params) {
    try {
      const { _id, ...updateData } = params
      const result = await db.collection('joint_banners')
        .doc(_id)
        .update({
          ...updateData,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async deleteBanner(params) {
    try {
      const result = await db.collection('joint_banners')
        .doc(params._id)
        .remove()
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async getIntros() {
    try {
      const result = await db.collection('joint_intros')
        .orderBy('order', 'asc')
        .get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async addIntro(params) {
    try {
      const result = await db.collection('joint_intros').add({
        ...params,
        create_time: new Date()
      })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async updateIntro(params) {
    try {
      const { _id, ...updateData } = params
      const result = await db.collection('joint_intros')
        .doc(_id)
        .update({
          ...updateData,
          update_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async deleteIntro(params) {
    try {
      const result = await db.collection('joint_intros')
        .doc(params._id)
        .remove()
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  }
}
```

### 通知系统云对象实现

```javascript
// uniCloud-aliyun/cloudfunctions/notification-system/index.obj.js

const db = uniCloud.database()

module.exports = {
  async getUnreadCount() {
    try {
      const result = await db.collection('admin_notifications')
        .where({ is_read: false })
        .count()
      return { success: true, count: result.total }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async getNotifications() {
    try {
      const result = await db.collection('admin_notifications')
        .orderBy('create_time', 'desc')
        .get()
      return { success: true, data: result.data }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async markAsRead(params) {
    try {
      const { notificationId } = params
      const result = await db.collection('admin_notifications')
        .doc(notificationId)
        .update({
          is_read: true,
          read_time: new Date()
        })
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async markAllAsRead() {
    try {
      const result = await db.collection('admin_notifications')
        .where({ is_read: false })
        .update({
          is_read: true,
          read_time: new Date()
        })
      return { success: true, updatedCount: result.updated }
    } catch (error) {
      return { success: false, message: error.message }
    }
  },

  async createNotification(params) {
    try {
      const { type, title, content, order_id, priority = 'normal' } = params
      const notification = {
        type,
        title,
        content,
        order_id,
        is_read: false,
        create_time: new Date(),
        priority
      }
      
      const result = await db.collection('admin_notifications').add(notification)
      return { success: true, data: result }
    } catch (error) {
      return { success: false, message: error.message }
    }
  }
}
```

## 前端调用方式

### 云函数调用方式（旧）
```javascript
// 旧方式：每个接口一个云函数
const result1 = await uniCloud.callFunction({
  name: 'getJointProjects'
})

const result2 = await uniCloud.callFunction({
  name: 'addJointProject',
  data: projectData
})
```

### 云对象调用方式（新）
```javascript
// 新方式：一个云对象包含多个接口
const jointManagement = uniCloud.importObject('joint-management')

const result1 = await jointManagement.getProjects()
const result2 = await jointManagement.addProject(projectData)
const result3 = await jointManagement.updateProject(updateData)
```

## 重构步骤

### 步骤1：创建云对象
1. 在 `uniCloud-aliyun/cloudfunctions/` 下创建云对象文件夹
2. 创建 `index.obj.js` 文件
3. 实现相关接口方法

### 步骤2：上传云对象
1. 右键点击云对象文件夹
2. 选择 "上传部署"

### 步骤3：修改前端代码
1. 将云函数调用改为云对象调用
2. 更新所有相关页面的调用方式

### 步骤4：删除旧云函数
1. 确认新云对象功能正常后
2. 删除对应的旧云函数

## 预期效果

### 云函数数量减少
- **重构前**：约 65 个云函数
- **重构后**：约 4 个云对象
- **减少比例**：约 94%

### 管理效率提升
- 代码集中管理，易于维护
- 接口复用，减少重复代码
- 部署效率大幅提升

### 成本降低
- 云函数数量大幅减少
- 避免云函数数量上限问题
- 降低维护成本

## 注意事项

1. **兼容性**：确保 HBuilderX 版本支持云对象
2. **测试**：重构后需要全面测试功能
3. **备份**：重构前备份重要数据
4. **渐进式**：可以分模块逐步重构

## 建议实施顺序

1. **第一阶段**：创建通知系统云对象（最简单）
2. **第二阶段**：创建合坛法会管理云对象（最重要）
3. **第三阶段**：创建专场法会管理云对象
4. **第四阶段**：创建通用管理云对象

这样的重构方案可以彻底解决云函数数量上限问题，同时提升代码质量和维护效率。 