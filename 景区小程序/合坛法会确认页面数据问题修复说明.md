# 合坛法会确认页面数据问题修复说明

## 问题描述

合坛法会报名确认页面显示的不是当前填写的信息，而是之前旧的信息。

## 问题原因

1. **数据存储机制问题**：表单页面和确认页面之间的数据传递存在缓存问题
2. **本地存储覆盖**：新的数据可能被旧数据覆盖
3. **数据加载时机**：确认页面加载时可能获取到的是缓存数据

## 解决方案

### 1. 改进数据传递机制

**修改前**：
- 表单页面保存数据到本地存储
- 确认页面从本地存储读取数据

**修改后**：
- 表单页面通过URL参数传递最新数据
- 确认页面优先从URL参数获取数据
- 本地存储作为备用数据源

### 2. 增强数据加载逻辑

```javascript
// 确认页面数据加载逻辑
loadOrderData() {
  // 1. 优先从URL参数获取数据
  const options = currentPage.options || {}
  if (options.orderData) {
    orderData = JSON.parse(decodeURIComponent(options.orderData))
  }
  
  // 2. 如果没有URL参数，从本地存储获取
  if (!orderData) {
    orderData = uni.getStorageSync('joint_fahui_order')
  }
  
  // 3. 如果还是没有，尝试从草稿获取
  if (!orderData) {
    const draft = uni.getStorageSync('joint_fahui_draft')
    if (draft) {
      orderData = this.convertDraftToOrder(draft)
    }
  }
}
```

### 3. 添加数据清理功能

**表单页面**：
- 每次显示页面时检查是否有旧数据
- 提示用户是否清除旧数据重新填写
- 确保数据的新鲜性

**确认页面**：
- 每次显示页面时重新加载数据
- 清理和标准化数据格式
- 重新保存到本地存储

### 4. 数据标准化处理

```javascript
// 清理和标准化订单数据
cleanOrderData(orderData) {
  return {
    projectName: orderData.projectName || orderData.project_name || '合坛法会',
    applicantCount: orderData.applicantCount || (orderData.applicants ? orderData.applicants.length : 0),
    applicants: orderData.applicants || [],
    selectedItems: orderData.selectedItems || orderData.goods || [],
    receiver: orderData.receiver || null,
    activityFee: orderData.activityFee || orderData.activity_fee || 0,
    goodsFee: orderData.goodsFee || orderData.goods_fee || 0,
    totalFee: orderData.totalFee || orderData.total_fee || 0,
    // ... 其他字段
  }
}
```

## 修改的文件

### 1. pages/fahui/joint/form.vue
- 添加数据清理功能
- 改进数据传递方式
- 通过URL参数传递最新数据

### 2. pages/fahui/joint/confirm.vue
- 改进数据加载逻辑
- 添加数据标准化处理
- 增加多重数据源支持

## 功能特点

### 1. 多重数据源
- URL参数（最新数据）
- 本地存储（备用数据）
- 草稿数据（兜底数据）

### 2. 数据新鲜性保证
- 每次显示页面重新加载数据
- 自动清理和标准化数据
- 提示用户清除旧数据

### 3. 错误处理
- 完善的错误提示
- 自动回退机制
- 用户友好的提示信息

## 使用流程

### 1. 表单填写
1. 用户填写合坛法会报名信息
2. 系统自动保存草稿
3. 点击下一步时生成完整订单数据

### 2. 数据传递
1. 表单页面通过URL参数传递最新数据
2. 同时保存到本地存储作为备用
3. 清除草稿数据

### 3. 确认页面
1. 优先从URL参数获取数据
2. 如果没有则从本地存储获取
3. 清理和标准化数据
4. 重新保存到本地存储

### 4. 数据清理
1. 表单页面检测到旧数据时提示用户
2. 用户可选择清除旧数据重新填写
3. 确保数据的新鲜性

## 测试建议

### 1. 基本功能测试
- 填写表单信息
- 跳转到确认页面
- 检查显示的信息是否正确

### 2. 数据持久化测试
- 填写部分信息后退出
- 重新进入页面
- 检查草稿是否正确加载

### 3. 数据清理测试
- 完成一次报名流程
- 重新进入表单页面
- 检查是否提示清除旧数据

### 4. 错误处理测试
- 模拟数据丢失情况
- 检查错误提示是否友好
- 验证回退机制是否正常

## 注意事项

1. **数据格式统一**：确保所有数据字段名称统一
2. **编码处理**：URL参数传递时正确处理编码
3. **存储限制**：注意本地存储的大小限制
4. **用户体验**：提供清晰的提示信息

## 后续优化

1. **数据版本控制**：添加数据版本号，确保数据一致性
2. **实时同步**：考虑使用全局状态管理
3. **数据压缩**：对大量数据进行压缩存储
4. **缓存策略**：优化数据缓存策略 