# 云对象调用示例

## 从云函数调用改为云对象调用

### 1. 通知系统调用示例

#### 旧方式：云函数调用
```javascript
// 获取未读通知数量
async loadUnreadCount() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getUnreadNotificationCount'
    })
    this.unreadCount = result.result.count || 0
  } catch (error) {
    console.error('加载未读通知数量失败:', error)
  }
}

// 获取通知列表
async loadNotifications() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getAdminNotifications'
    })
    this.notifications = result.result.data || []
  } catch (error) {
    console.error('加载通知失败:', error)
  }
}

// 标记通知为已读
async markAsRead(notificationId) {
  try {
    await uniCloud.callFunction({
      name: 'markNotificationAsRead',
      data: { notificationId }
    })
    // 重新加载数据
    this.loadNotifications()
  } catch (error) {
    console.error('标记已读失败:', error)
  }
}

// 标记所有通知为已读
async markAllAsRead() {
  try {
    await uniCloud.callFunction({
      name: 'markAllNotificationsAsRead'
    })
    // 重新加载数据
    this.loadNotifications()
  } catch (error) {
    console.error('标记所有已读失败:', error)
  }
}
```

#### 新方式：云对象调用
```javascript
// 导入云对象
const notificationSystem = uniCloud.importObject('notification-system')

// 获取未读通知数量
async loadUnreadCount() {
  try {
    const result = await notificationSystem.getUnreadCount()
    if (result.success) {
      this.unreadCount = result.count || 0
    }
  } catch (error) {
    console.error('加载未读通知数量失败:', error)
  }
}

// 获取通知列表
async loadNotifications() {
  try {
    const result = await notificationSystem.getNotifications()
    if (result.success) {
      this.notifications = result.data || []
    }
  } catch (error) {
    console.error('加载通知失败:', error)
  }
}

// 标记通知为已读
async markAsRead(notificationId) {
  try {
    const result = await notificationSystem.markAsRead({ notificationId })
    if (result.success) {
      uni.showToast({ title: '已标记为已读', icon: 'success' })
      // 重新加载数据
      this.loadNotifications()
      this.loadUnreadCount()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('标记已读失败:', error)
    uni.showToast({ title: '操作失败', icon: 'none' })
  }
}

// 标记所有通知为已读
async markAllAsRead() {
  try {
    const result = await notificationSystem.markAllAsRead()
    if (result.success) {
      uni.showToast({ 
        title: `已标记 ${result.updatedCount} 条通知为已读`, 
        icon: 'success' 
      })
      // 重新加载数据
      this.loadNotifications()
      this.loadUnreadCount()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('标记所有已读失败:', error)
    uni.showToast({ title: '操作失败', icon: 'none' })
  }
}

// 创建通知
async createNotification(params) {
  try {
    const result = await notificationSystem.createNotification(params)
    if (result.success) {
      uni.showToast({ title: '通知创建成功', icon: 'success' })
      return result.notification_id
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
      return null
    }
  } catch (error) {
    console.error('创建通知失败:', error)
    uni.showToast({ title: '创建失败', icon: 'none' })
    return null
  }
}

// 删除通知
async deleteNotification(notificationId) {
  try {
    const result = await notificationSystem.deleteNotification({ notificationId })
    if (result.success) {
      uni.showToast({ title: '通知已删除', icon: 'success' })
      // 重新加载数据
      this.loadNotifications()
      this.loadUnreadCount()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('删除通知失败:', error)
    uni.showToast({ title: '删除失败', icon: 'none' })
  }
}
```

### 2. 合坛法会管理调用示例

#### 旧方式：云函数调用
```javascript
// 获取项目列表
async loadProjects() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getJointProjects'
    })
    this.projects = result.result.data || []
  } catch (error) {
    console.error('加载项目失败:', error)
  }
}

// 添加项目
async addProject(projectData) {
  try {
    await uniCloud.callFunction({
      name: 'addJointProject',
      data: projectData
    })
    uni.showToast({ title: '添加成功', icon: 'success' })
    this.loadProjects()
  } catch (error) {
    console.error('添加项目失败:', error)
  }
}

// 更新项目
async updateProject(updateData) {
  try {
    await uniCloud.callFunction({
      name: 'updateJointProject',
      data: updateData
    })
    uni.showToast({ title: '更新成功', icon: 'success' })
    this.loadProjects()
  } catch (error) {
    console.error('更新项目失败:', error)
  }
}

// 删除项目
async deleteProject(projectId) {
  try {
    await uniCloud.callFunction({
      name: 'deleteJointProject',
      data: { _id: projectId }
    })
    uni.showToast({ title: '删除成功', icon: 'success' })
    this.loadProjects()
  } catch (error) {
    console.error('删除项目失败:', error)
  }
}
```

#### 新方式：云对象调用
```javascript
// 导入云对象
const jointManagement = uniCloud.importObject('joint-management')

// 获取项目列表
async loadProjects() {
  try {
    const result = await jointManagement.getProjects()
    if (result.success) {
      this.projects = result.data || []
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('加载项目失败:', error)
    uni.showToast({ title: '加载失败', icon: 'none' })
  }
}

// 添加项目
async addProject(projectData) {
  try {
    const result = await jointManagement.addProject(projectData)
    if (result.success) {
      uni.showToast({ title: '添加成功', icon: 'success' })
      this.loadProjects()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('添加项目失败:', error)
    uni.showToast({ title: '添加失败', icon: 'none' })
  }
}

// 更新项目
async updateProject(updateData) {
  try {
    const result = await jointManagement.updateProject(updateData)
    if (result.success) {
      uni.showToast({ title: '更新成功', icon: 'success' })
      this.loadProjects()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('更新项目失败:', error)
    uni.showToast({ title: '更新失败', icon: 'none' })
  }
}

// 删除项目
async deleteProject(projectId) {
  try {
    const result = await jointManagement.deleteProject({ _id: projectId })
    if (result.success) {
      uni.showToast({ title: '删除成功', icon: 'success' })
      this.loadProjects()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('删除项目失败:', error)
    uni.showToast({ title: '删除失败', icon: 'none' })
  }
}

// 获取订单列表
async loadOrders() {
  try {
    const result = await jointManagement.getOrders()
    if (result.success) {
      this.orders = result.data || []
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('加载订单失败:', error)
    uni.showToast({ title: '加载失败', icon: 'none' })
  }
}

// 更新订单状态
async updateOrderStatus(params) {
  try {
    const result = await jointManagement.updateOrderStatus(params)
    if (result.success) {
      uni.showToast({ title: '状态更新成功', icon: 'success' })
      this.loadOrders()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('更新订单状态失败:', error)
    uni.showToast({ title: '更新失败', icon: 'none' })
  }
}

// 添加订单备注
async addOrderRemark(params) {
  try {
    const result = await jointManagement.addOrderRemark(params)
    if (result.success) {
      uni.showToast({ title: '备注添加成功', icon: 'success' })
      this.loadOrders()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('添加备注失败:', error)
    uni.showToast({ title: '添加失败', icon: 'none' })
  }
}

// 导出订单
async exportOrders() {
  try {
    uni.showLoading({ title: '正在导出...' })
    const result = await jointManagement.exportOrders()
    if (result.success) {
      // 生成CSV文件
      const csvContent = this.generateCSV(result.data)
      
      // 复制到剪贴板
      uni.setClipboardData({
        data: csvContent,
        success: () => {
          uni.hideLoading()
          uni.showModal({
            title: '导出成功',
            content: '订单数据已复制到剪贴板，请粘贴到Excel中查看',
            showCancel: false
          })
        }
      })
    } else {
      uni.hideLoading()
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    uni.hideLoading()
    console.error('导出订单失败:', error)
    uni.showToast({ title: '导出失败', icon: 'none' })
  }
}
```

## 优势对比

### 云函数调用的缺点
1. **数量限制**：每个接口需要一个云函数，容易达到上限
2. **管理复杂**：需要管理大量云函数文件
3. **代码重复**：相似功能需要重复编写
4. **部署繁琐**：需要逐个部署云函数

### 云对象调用的优点
1. **数量优势**：1个云对象可以包含多个接口
2. **管理简单**：集中管理，易于维护
3. **代码复用**：共享方法和数据，减少重复
4. **部署高效**：一次部署多个接口
5. **类型安全**：更好的类型检查和IDE支持
6. **性能优化**：减少网络请求，提高效率

## 迁移建议

### 1. 渐进式迁移
- 先迁移通知系统（最简单）
- 再迁移合坛法会管理（最重要）
- 最后迁移其他模块

### 2. 测试验证
- 每个模块迁移后都要充分测试
- 确保功能完全正常后再迁移下一个

### 3. 代码备份
- 迁移前备份原有代码
- 保留旧云函数作为备份

### 4. 文档更新
- 更新API文档
- 更新调用示例
- 更新部署说明

通过使用云对象，可以彻底解决云函数数量上限问题，同时提升代码质量和维护效率。 