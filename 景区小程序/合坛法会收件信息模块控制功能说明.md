# 合坛法会收件信息模块控制功能说明

## 功能概述

合坛法会收件信息模块支持后台控制，管理员可以在后台设置是否启用该模块，以及配置各个字段的必填性。前台会根据后台设置自动显示或隐藏收件信息填写区域。

## 功能特点

### 1. 后台控制
- **模块开关**：可以启用或禁用整个收件信息模块
- **字段配置**：可以设置收件人姓名、电话、地址的必填性
- **实时生效**：配置修改后前台立即生效

### 2. 前台显示
- **条件显示**：只有在后台启用时才显示收件信息区域
- **动态验证**：根据后台配置进行必填项验证
- **智能提示**：根据配置显示不同的提示文字

## 后台管理

### 管理页面
- **路径**：`pages/admin/joint/receiver.vue`
- **功能**：合坛法会收件信息管理

### 配置选项
1. **模块开关**
   - 启用/禁用整个收件信息模块
   - 启用后前台显示收件信息填写功能

2. **字段配置**
   - **收件人姓名**：可设置为必填或选填
   - **收件人电话**：可设置为必填或选填
   - **收件地址**：可设置为必填或选填

3. **收件人列表**
   - 查看用户提交的收件信息
   - 支持复制信息和删除操作

## 前台实现

### 显示逻辑
```vue
<!-- 收件信息 -->
<view class="section-title" v-if="showReceiver">
  收件信息 
  <text class="section-tip" v-if="!receiverConfig || (!receiverConfig.nameRequired && !receiverConfig.phoneRequired && !receiverConfig.addressRequired)">（可选）</text>
  <text class="section-tip" v-else>（必填项已标记*）</text>
</view>
<view v-if="showReceiver" class="card">
  <!-- 收件信息表单 -->
</view>
```

### 配置加载
```javascript
async loadReceiverConfig() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getJointReceiverConfig'
    })
    
    if (result.result && result.result.data) {
      this.receiverConfig = result.result.data
      this.showReceiver = result.result.data.enabled || false
    } else {
      this.receiverConfig = null
      this.showReceiver = false
    }
  } catch (error) {
    console.error('加载收件信息配置失败:', error)
    this.receiverConfig = null
    this.showReceiver = false
  }
}
```

### 表单验证
```javascript
// 收件信息验证
if (this.showReceiver) {
  const receiverConfig = await this.getReceiverConfig()
  if (receiverConfig) {
    if (receiverConfig.nameRequired && !this.receiver.name.trim()) {
      uni.showToast({
        title: '请填写收件人姓名',
        icon: 'none'
      })
      return false
    }
    
    if (receiverConfig.phoneRequired && !this.receiver.phone.trim()) {
      uni.showToast({
        title: '请填写收件人电话',
        icon: 'none'
      })
      return false
    }
    
    if (receiverConfig.addressRequired && !this.receiver.address.trim()) {
      uni.showToast({
        title: '请填写收件地址',
        icon: 'none'
      })
      return false
    }
  }
}
```

## 相关云函数

### 1. getJointReceiverConfig
- **功能**：获取收件信息模块配置
- **返回**：模块启用状态和各字段必填配置

### 2. updateJointReceiverConfig
- **功能**：更新收件信息模块配置
- **参数**：enabled, nameRequired, phoneRequired, addressRequired

### 3. getJointReceivers
- **功能**：获取收件人信息列表
- **返回**：用户提交的收件信息数组

### 4. deleteJointReceiver
- **功能**：删除收件人信息
- **参数**：收件人信息ID

## 数据库结构

### joint_receiver_config 集合
```javascript
{
  _id: "配置ID",
  enabled: true,           // 模块是否启用
  nameRequired: true,      // 姓名是否必填
  phoneRequired: true,     // 电话是否必填
  addressRequired: true,   // 地址是否必填
  create_time: "创建时间",
  update_time: "更新时间"
}
```

### joint_receivers 集合
```javascript
{
  _id: "收件人ID",
  name: "收件人姓名",
  phone: "联系电话",
  address: "收件地址",
  orderId: "关联订单ID",
  createTime: "创建时间"
}
```

## 使用流程

### 1. 后台配置
1. 进入合坛法会收件信息管理页面
2. 启用收件信息模块
3. 配置各字段的必填性
4. 保存配置

### 2. 前台使用
1. 用户填写法会报名信息
2. 如果收件信息模块已启用，显示收件信息填写区域
3. 根据后台配置进行必填项验证
4. 提交订单时包含收件信息

### 3. 后台查看
1. 在收件信息管理页面查看用户提交的收件信息
2. 可以复制收件信息或删除记录

## 注意事项

1. **配置生效**：后台配置修改后，前台需要刷新页面才能看到最新配置
2. **数据安全**：收件信息包含用户隐私，需要妥善保管
3. **验证逻辑**：前台会根据后台配置动态调整验证规则
4. **默认状态**：如果后台未配置，默认不显示收件信息模块

## 相关文件

- `pages/admin/joint/receiver.vue` - 后台管理页面
- `pages/fahui/joint/form.vue` - 前台表单页面
- `uniCloud-aliyun/cloudfunctions/getJointReceiverConfig/` - 获取配置云函数
- `uniCloud-aliyun/cloudfunctions/updateJointReceiverConfig/` - 更新配置云函数
- `uniCloud-aliyun/cloudfunctions/getJointReceivers/` - 获取收件人列表云函数
- `uniCloud-aliyun/cloudfunctions/deleteJointReceiver/` - 删除收件人云函数 