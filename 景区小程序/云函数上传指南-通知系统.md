# 通知系统云函数上传指南

## 问题描述

错误信息显示：`云函数[getUnreadNotificationCount]在云端不存在，请检查此云函数名称是否正确以及该云函数是否已上传到服务空间`

## 解决方案

需要将通知系统相关的云函数上传到云端。

## 需要上传的云函数列表

根据通知系统的实现，以下云函数需要确保已上传：

1. ✅ `getUnreadNotificationCount` - 获取未读通知数量
2. ✅ `getAdminNotifications` - 获取管理员通知列表
3. ✅ `markNotificationAsRead` - 标记通知为已读
4. ✅ `markAllNotificationsAsRead` - 标记所有通知为已读
5. ✅ `notifyAdminOnPayment` - 支付成功通知（已修改）

## 上传步骤

### 方法一：使用 HBuilderX 上传

#### 单个云函数上传
1. **打开 HBuilderX**
2. **找到云函数目录**
   - 在项目根目录下找到 `uniCloud-aliyun/cloudfunctions/` 文件夹
3. **逐个上传云函数**
   - 右键点击 `getUnreadNotificationCount` 文件夹 → 选择 "上传部署"
   - 右键点击 `getAdminNotifications` 文件夹 → 选择 "上传部署"
   - 右键点击 `markNotificationAsRead` 文件夹 → 选择 "上传部署"
   - 右键点击 `markAllNotificationsAsRead` 文件夹 → 选择 "上传部署"
4. **确认上传**
   - 在弹出的对话框中确认上传
   - 等待上传完成

#### 批量上传所有云函数
1. **在 HBuilderX 中**
   - 右键点击 `uniCloud-aliyun/cloudfunctions/` 文件夹
   - 选择 "上传所有云函数"

### 方法二：使用命令行上传

如果你使用命令行工具：

```bash
# 进入云函数根目录
cd uniCloud-aliyun/cloudfunctions

# 上传所有云函数
uniCloud deploy --all

# 或者单独上传特定云函数
cd getUnreadNotificationCount
uniCloud deploy

cd ../getAdminNotifications
uniCloud deploy

cd ../markNotificationAsRead
uniCloud deploy

cd ../markAllNotificationsAsRead
uniCloud deploy
```

## 云函数功能说明

### 1. getUnreadNotificationCount
- **功能**：获取未读通知数量
- **用途**：在后台首页显示未读通知徽章
- **返回**：未读通知的数量

### 2. getAdminNotifications
- **功能**：获取管理员通知列表
- **用途**：在通知管理页面显示所有通知
- **返回**：通知列表数据

### 3. markNotificationAsRead
- **功能**：标记单个通知为已读
- **用途**：点击通知时标记为已读
- **参数**：notificationId（通知ID）

### 4. markAllNotificationsAsRead
- **功能**：标记所有未读通知为已读
- **用途**：一键标记所有通知为已读
- **返回**：更新的通知数量

### 5. notifyAdminOnPayment
- **功能**：支付成功时创建管理员通知
- **用途**：合坛法会订单支付成功后自动通知管理员
- **参数**：order（订单信息）

## 验证上传成功

上传完成后，可以通过以下方式验证：

### 1. 在 HBuilderX 中
- 打开云函数列表
- 确认以下云函数显示为已上传状态：
  - `getUnreadNotificationCount`
  - `getAdminNotifications`
  - `markNotificationAsRead`
  - `markAllNotificationsAsRead`

### 2. 在 uniCloud 控制台
- 登录 uniCloud 控制台
- 进入云函数管理
- 确认所有云函数都存在

### 3. 功能测试
- 重新访问后台首页
- 确认不再出现云函数不存在的错误
- 检查通知徽章是否正常显示
- 测试通知管理页面功能

## 数据库依赖

通知系统需要以下数据库集合：

### admin_notifications 集合
```javascript
{
  _id: "通知ID",
  type: "通知类型", // 如 'joint_order_paid'
  title: "通知标题",
  content: "通知内容",
  order_id: "相关订单ID",
  is_read: false, // 是否已读
  create_time: "创建时间",
  priority: "优先级" // 如 'high'
}
```

### 自动创建
如果数据库集合不存在，云函数会自动创建。

## 常见问题

### 1. 上传失败
- 检查网络连接
- 确认 uniCloud 服务空间配置正确
- 检查云函数代码是否有语法错误

### 2. 权限问题
- 确认当前账号有上传云函数的权限
- 检查服务空间配置

### 3. 版本冲突
- 如果云端已有同名函数，会提示是否覆盖
- 选择覆盖即可

### 4. 数据库权限
- 确认云函数有数据库读写权限
- 检查数据库集合是否存在

## 完成后的效果

上传成功后，通知系统将正常工作：

1. **后台首页**
   - 显示未读通知数量徽章
   - 点击可进入通知管理页面

2. **通知管理页面**
   - 显示所有通知列表
   - 支持标记单个通知为已读
   - 支持一键标记所有通知为已读
   - 显示通知详情和操作日志

3. **自动通知**
   - 合坛法会订单支付成功后自动创建通知
   - 通知包含订单关键信息

## 注意事项

1. **上传顺序**：建议先上传基础云函数，再上传依赖的云函数
2. **测试验证**：上传后及时测试功能是否正常
3. **数据备份**：如有重要数据，建议先备份
4. **环境确认**：确认上传到正确的服务空间

## 故障排除

如果上传后仍有问题：

1. **检查控制台错误**：查看浏览器控制台的具体错误信息
2. **验证云函数**：在 uniCloud 控制台测试云函数
3. **检查数据库**：确认数据库集合和权限设置
4. **重新上传**：如有必要，删除云端云函数后重新上传 