<template>
  <view class="success-page">
    <!-- æˆåŠŸå›¾æ ‡ -->
    <view class="success-icon">
      <view class="icon-circle">
        <text class="icon-text">âœ“</text>
      </view>
    </view>

    <!-- æˆåŠŸæ ‡é¢˜ -->
    <view class="success-title">æŠ¥åæˆåŠŸ</view>
    <view class="success-subtitle">æ‚¨çš„åˆå›æ³•ä¼šæŠ¥åå·²æäº¤æˆåŠŸ</view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="order-card">
        <view class="order-info">
          <text class="order-label">è®¢å•å·ï¼š</text>
          <text class="order-value">{{ orderInfo.orderId }}</text>
        </view>
        <view class="order-info">
          <text class="order-label">æ³•ä¼šé¡¹ç›®ï¼š</text>
          <text class="order-value">{{ orderInfo.projectName }}</text>
        </view>
        <view class="order-info">
          <text class="order-label">æŠ¥åäººæ•°ï¼š</text>
          <text class="order-value">{{ orderInfo.applicantCount }}äºº</text>
        </view>
        <view class="order-info">
          <text class="order-label">æ”¯ä»˜é‡‘é¢ï¼š</text>
          <text class="order-value total-amount">Â¥{{ orderInfo.totalFee }}</text>
        </view>
        <view class="order-info">
          <text class="order-label">æ”¯ä»˜æ—¶é—´ï¼š</text>
          <text class="order-value">{{ orderInfo.payTime }}</text>
        </view>
      </view>
    </view>

    <!-- ä»£åŠç‰©å“ï¼ˆå¦‚æœ‰é€‰æ‹©ï¼‰ -->
    <view v-if="orderInfo.selectedItems && orderInfo.selectedItems.length > 0" class="section">
      <view class="section-title">ä»£åŠç‰©å“</view>
      <view class="goods-list">
        <view v-for="(item, index) in orderInfo.selectedItems" :key="'goods-' + index" class="goods-item">
          <view class="goods-info">
            <text class="goods-name">{{ item.name }}</text>
            <text class="goods-price">Â¥{{ item.price }}/ä»¶</text>
          </view>
          <view class="goods-count">
            <text class="count-label">æ•°é‡ï¼š</text>
            <text class="count-value">{{ item.count }}ä»¶</text>
          </view>
          <view class="goods-total">
            <text class="total-label">å°è®¡ï¼š</text>
            <text class="total-value">Â¥{{ item.price * item.count }}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åç»­æ­¥éª¤ -->
    <view class="section">
      <view class="section-title">åç»­æ­¥éª¤</view>
      <view class="steps-card">
        <view class="step-item">
          <view class="step-number">1</view>
          <view class="step-content">
            <text class="step-title">ç­‰å¾…ç¡®è®¤</text>
            <text class="step-desc">é“é•¿å°†åœ¨24å°æ—¶å†…ä¸æ‚¨è”ç³»ç¡®è®¤æ³•ä¼šå…·ä½“æ—¶é—´</text>
          </view>
        </view>
        <view class="step-item">
          <view class="step-number">2</view>
          <view class="step-content">
            <text class="step-title">å‚åŠ æ³•ä¼š</text>
            <text class="step-desc">æŒ‰ç…§çº¦å®šæ—¶é—´å‚åŠ åˆå›æ³•ä¼šï¼Œå…±åŒç¥ˆç¦</text>
          </view>
        </view>
        <view class="step-item">
          <view class="step-number">3</view>
          <view class="step-content">
            <text class="step-title">åŠŸå¾·å›å‘</text>
            <text class="step-desc">æ³•ä¼šç»“æŸåï¼ŒåŠŸå¾·å°†å›å‘ç»™æ‰€æœ‰å‚ä¸è€…</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ³¨æ„äº‹é¡¹ -->
    <view class="section">
      <view class="section-title">æ³¨æ„äº‹é¡¹</view>
      <view class="notice-card">
        <view class="notice-item">
          <text class="notice-dot">â€¢</text>
          <text class="notice-text">è¯·ä¿æŒæ‰‹æœºç•…é€šï¼Œä»¥ä¾¿é“é•¿åŠæ—¶è”ç³»</text>
        </view>
        <view class="notice-item">
          <text class="notice-dot">â€¢</text>
          <text class="notice-text">æ³•ä¼šå½“å¤©è¯·æå‰åˆ°è¾¾ï¼Œä¿æŒæ­æ•¬å¿ƒ</text>
        </view>
        <view class="notice-item">
          <text class="notice-dot">â€¢</text>
          <text class="notice-text">å¦‚æœ‰ç‰¹æ®Šæƒ…å†µéœ€è¦å–æ¶ˆï¼Œè¯·æå‰è”ç³»</text>
        </view>
        <view class="notice-item">
          <text class="notice-dot">â€¢</text>
          <text class="notice-text">æ³•ä¼šæœŸé—´è¯·éµå®ˆé“è§‚è§„å®šï¼Œä¿æŒå®‰é™</text>
        </view>
      </view>
    </view>

    <!-- è”ç³»æ–¹å¼ -->
    <view class="section">
      <view class="section-title">è”ç³»æ–¹å¼</view>
      <view class="contact-card">
        <view class="contact-item">
          <text class="contact-label">å®¢æœç”µè¯ï¼š</text>
          <text class="contact-value" @click="makeCall('400-123-4567')">400-123-4567</text>
        </view>
        <view class="contact-item">
          <text class="contact-label">å¾®ä¿¡å®¢æœï¼š</text>
          <text class="contact-value">fahui_service</text>
        </view>
        <view class="contact-item">
          <text class="contact-label">æœåŠ¡æ—¶é—´ï¼š</text>
          <text class="contact-value">09:00-18:00ï¼ˆå‘¨ä¸€è‡³å‘¨æ—¥ï¼‰</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="btn-secondary" @click="viewOrder">æŸ¥çœ‹è®¢å•</button>
      <button class="btn-primary" @click="goHome">è¿”å›é¦–é¡µ</button>
    </view>
  </view>
</template>

<script>
// å¯¼å…¥äº‘å¯¹è±¡
const jointManagement = uniCloud.importObject('joint-management')

export default {
  data() {
    return {
      orderInfo: {
        orderId: '',
        projectName: '',
        applicantCount: 0,
        totalFee: 0,
        payTime: '',
        selectedItems: []
      }
    }
  },
  
  onLoad() {
    console.log('ğŸ‰ åˆå›æ³•ä¼šæˆåŠŸé¡µé¢åŠ è½½å¼€å§‹')
    this.loadOrderInfo()
    console.log('ğŸ‰ åˆå›æ³•ä¼šæˆåŠŸé¡µé¢åŠ è½½å®Œæˆ')
  },
  
  methods: {
    loadOrderInfo() {
      try {
        console.log('ğŸ‰ å¼€å§‹åŠ è½½æˆåŠŸé¡µé¢è®¢å•ä¿¡æ¯...')
        // ä¼˜å…ˆä»ç¡®è®¤é¡µé¢è·å–æ•°æ®
        const confirmData = uni.getStorageSync('joint_fahui_confirm')
        const orderData = uni.getStorageSync('joint_fahui_order')
        const orderId = uni.getStorageSync('joint_fahui_order_id')
        
        console.log('ğŸ‰ æœ¬åœ°å­˜å‚¨æ•°æ®:')
        console.log('  - confirmData:', confirmData)
        console.log('  - orderData:', orderData)
        console.log('  - orderId:', orderId)
        
        // ä½¿ç”¨ç¡®è®¤æ•°æ®æˆ–è®¢å•æ•°æ®
        const data = confirmData || orderData
        console.log('ğŸ‰ ä½¿ç”¨çš„æ•°æ®æº:', data ? (confirmData ? 'confirmData' : 'orderData') : 'æ— æ•°æ®')
        
        if (data) {
          this.orderInfo = {
            orderId: orderId || data.orderId || data._id || 'JT' + Date.now(),
            projectName: data.projectName || data.project_name || 'å¹³å®‰åˆå›',
            applicantCount: data.applicantCount || (data.applicants ? data.applicants.length : 0),
            totalFee: data.totalFee || data.total_fee || 0,
            payTime: this.formatTime(new Date()),
            selectedItems: data.selectedItems || data.goods || []
          }
          
          console.log('ğŸ‰ è®¢å•ä¿¡æ¯åŠ è½½æˆåŠŸ:')
          console.log('  - orderId:', this.orderInfo.orderId)
          console.log('  - projectName:', this.orderInfo.projectName)
          console.log('  - applicantCount:', this.orderInfo.applicantCount)
          console.log('  - totalFee:', this.orderInfo.totalFee)
          console.log('  - payTime:', this.orderInfo.payTime)
          console.log('  - selectedItemsæ•°é‡:', this.orderInfo.selectedItems ? this.orderInfo.selectedItems.length : 0)
        } else {
          console.log('âš ï¸ æ²¡æœ‰è®¢å•æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®')
          // å¦‚æœæ²¡æœ‰è®¢å•æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          this.orderInfo = {
            orderId: 'JT' + Date.now(),
            projectName: 'å¹³å®‰åˆå›',
            applicantCount: 2,
            totalFee: 400,
            payTime: this.formatTime(new Date())
          }
          console.log('ğŸ‰ æ¨¡æ‹Ÿè®¢å•ä¿¡æ¯:', this.orderInfo)
        }
      } catch (error) {
        console.error('âŒ åŠ è½½è®¢å•ä¿¡æ¯å¤±è´¥:', error)
        // ä½¿ç”¨é»˜è®¤æ•°æ®
        this.orderInfo = {
          orderId: 'JT' + Date.now(),
          projectName: 'å¹³å®‰åˆå›',
          applicantCount: 2,
          totalFee: 400,
          payTime: this.formatTime(new Date())
        }
        console.log('ğŸ‰ ä½¿ç”¨é»˜è®¤è®¢å•ä¿¡æ¯:', this.orderInfo)
      }
    },
    
    formatTime(date) {
      const year = date.getFullYear()
      const month = String(date.getMonth() + 1).padStart(2, '0')
      const day = String(date.getDate()).padStart(2, '0')
      const hours = String(date.getHours()).padStart(2, '0')
      const minutes = String(date.getMinutes()).padStart(2, '0')
      const seconds = String(date.getSeconds()).padStart(2, '0')
      
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
    },
    
    makeCall(phone) {
      uni.makePhoneCall({
        phoneNumber: phone,
        success: () => {
          console.log('æ‹¨æ‰“ç”µè¯æˆåŠŸ')
        },
        fail: (err) => {
          console.error('æ‹¨æ‰“ç”µè¯å¤±è´¥:', err)
          uni.showToast({
            title: 'æ‹¨æ‰“ç”µè¯å¤±è´¥',
            icon: 'none'
          })
        }
      })
    },
    
    viewOrder() {
      // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µé¢
      uni.navigateTo({
        url: '/pages/profile/orderDetail?type=joint&orderId=' + this.orderInfo.orderId,
        fail: () => {
          // å¦‚æœè·³è½¬å¤±è´¥ï¼Œè·³è½¬åˆ°ä¸ªäººä¸­å¿ƒçš„è®¢å•é¡µé¢
          uni.switchTab({
            url: '/pages/profile/index'
          })
        }
      })
    },
    
    goHome() {
      // è¿”å›é¦–é¡µ
      uni.switchTab({
        url: '/pages/index/index'
      })
    }
  }
}
</script>

<style scoped>
.success-page {
  min-height: 100vh;
  background: linear-gradient(180deg, #e0eaff 0%, #f8f8f8 100%);
  padding-bottom: 120rpx;
}

.success-icon {
  display: flex;
  justify-content: center;
  padding: 80rpx 0 40rpx 0;
}

.icon-circle {
  width: 120rpx;
  height: 120rpx;
  background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8rpx 32rpx rgba(82, 196, 26, 0.3);
}

.icon-text {
  color: #fff;
  font-size: 60rpx;
  font-weight: bold;
}

.success-title {
  font-size: 40rpx;
  font-weight: bold;
  color: #333;
  text-align: center;
  margin-bottom: 16rpx;
}

.success-subtitle {
  font-size: 28rpx;
  color: #666;
  text-align: center;
  margin-bottom: 48rpx;
}

.section {
  margin: 24rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 16rpx;
  display: flex;
  align-items: center;
}

.section-title::before {
  content: '';
  width: 8rpx;
  height: 32rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 4rpx;
  margin-right: 16rpx;
}

.order-card, .steps-card, .notice-card, .contact-card {
  background: #fff;
  border-radius: 16rpx;
  padding: 24rpx;
  box-shadow: 0 4rpx 16rpx rgba(0,0,0,0.08);
}

.order-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
}

.order-info:last-child {
  border-bottom: none;
}

.order-label {
  font-size: 28rpx;
  color: #666;
  min-width: 160rpx;
}

.order-value {
  font-size: 28rpx;
  color: #333;
  font-weight: bold;
  text-align: right;
  flex: 1;
}

.total-amount {
  color: #ff6b35;
  font-size: 32rpx;
}

.step-item {
  display: flex;
  align-items: flex-start;
  margin-bottom: 32rpx;
}

.step-item:last-child {
  margin-bottom: 0;
}

.step-number {
  width: 48rpx;
  height: 48rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24rpx;
  font-weight: bold;
  margin-right: 20rpx;
  flex-shrink: 0;
}

.step-content {
  flex: 1;
}

.step-title {
  font-size: 28rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 8rpx;
  display: block;
}

.step-desc {
  font-size: 26rpx;
  color: #666;
  line-height: 1.5;
  display: block;
}

.notice-item {
  display: flex;
  align-items: flex-start;
  margin-bottom: 16rpx;
}

.notice-item:last-child {
  margin-bottom: 0;
}

.notice-dot {
  color: #667eea;
  font-size: 28rpx;
  margin-right: 12rpx;
  margin-top: 4rpx;
}

.notice-text {
  font-size: 26rpx;
  color: #666;
  line-height: 1.5;
  flex: 1;
}

.contact-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
}

.contact-item:last-child {
  border-bottom: none;
}

.contact-label {
  font-size: 28rpx;
  color: #666;
  min-width: 160rpx;
}

.contact-value {
  font-size: 28rpx;
  color: #333;
  font-weight: bold;
  text-align: right;
  flex: 1;
}

.contact-value:active {
  color: #667eea;
}

.action-buttons {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  padding: 24rpx;
  box-shadow: 0 -4rpx 16rpx rgba(0,0,0,0.1);
  display: flex;
  gap: 16rpx;
}

.btn-secondary, .btn-primary {
  flex: 1;
  padding: 24rpx;
  border-radius: 50rpx;
  font-size: 32rpx;
  font-weight: bold;
  border: none;
}

.btn-secondary {
  background: #f5f5f5;
  color: #666;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  box-shadow: 0 8rpx 32rpx rgba(102, 126, 234, 0.3);
}

.goods-list {
  display: flex;
  flex-direction: column;
  gap: 16rpx;
}

.goods-item {
  background: #fff;
  border-radius: 12rpx;
  padding: 24rpx;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.04);
}

.goods-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12rpx;
}

.goods-name {
  font-size: 28rpx;
  font-weight: bold;
  color: #333;
}

.goods-price {
  font-size: 26rpx;
  color: #667eea;
  font-weight: bold;
}

.goods-count {
  display: flex;
  align-items: center;
  margin-bottom: 8rpx;
}

.count-label {
  font-size: 26rpx;
  color: #666;
  margin-right: 8rpx;
}

.count-value {
  font-size: 26rpx;
  color: #333;
  font-weight: bold;
}

.goods-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 8rpx;
  border-top: 1rpx solid #f0f0f0;
}

.total-label {
  font-size: 26rpx;
  color: #666;
}

.total-value {
  font-size: 28rpx;
  color: #667eea;
  font-weight: bold;
}
</style> 