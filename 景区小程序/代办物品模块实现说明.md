# 代办物品模块实现说明

## 需求回顾

**需求**：设置"代办物品"模块（代办物品名称、单价），不设置前台不显示此模块

## 实现逻辑

### 1. 后台设置逻辑

#### 项目管理页面 (`pages/admin/joint/projects.vue`)
- 每个项目可以设置多个代办物品
- 代办物品包含：名称、价格、描述
- 通过"物品"按钮进入项目专用代办物品管理页面

#### 代办物品管理页面 (`pages/admin/joint/goods.vue`)
- 管理特定项目的代办物品
- 支持添加、编辑、删除代办物品
- 每个物品包含：名称、价格、描述

#### 代办物品总览页面 (`pages/admin/joint/goods-overview.vue`)
- 一站式查看所有项目的代办物品
- 支持快速添加、编辑、删除操作
- 提供统计信息

### 2. 前台显示逻辑

#### 显示条件
```javascript
// 只有当后台设置了代办物品时才显示
v-if="showItems"
```

#### 加载时机
```javascript
// 选择项目后自动加载该项目的代办物品
async onProjectChange(e) {
  // ... 其他逻辑
  
  // 加载选中项目的代办物品
  if (this.currentProject && this.currentProject._id) {
    await this.loadItemsConfig(this.currentProject._id)
  } else {
    this.showItems = false
    this.items = []
  }
}
```

#### 加载方法
```javascript
async loadItemsConfig(projectId) {
  if (!projectId) {
    this.showItems = false
    this.items = []
    return
  }
  
  try {
    const result = await uniCloud.callFunction({
      name: 'getJointGoods',
      data: { projectId }
    })
    
    if (result.result && result.result.data && result.result.data.length > 0) {
      this.showItems = true
      this.items = result.result.data.map(item => ({
        ...item,
        count: 0
      }))
    } else {
      this.showItems = false
      this.items = []
    }
  } catch (error) {
    console.error('加载代办物品配置失败:', error)
    this.showItems = false
    this.items = []
  }
}
```

### 3. 数据流程

#### 后台设置流程
1. 管理员在项目管理页面点击"物品"按钮
2. 进入项目专用代办物品管理页面
3. 添加、编辑、删除代办物品
4. 数据保存到 `joint_projects` 集合的 `goods` 字段

#### 前台显示流程
1. 用户选择法会项目
2. 系统自动调用 `getJointGoods` 云函数
3. 获取该项目的代办物品列表
4. 如果有物品，设置 `showItems = true` 并显示
5. 如果没有物品，设置 `showItems = false` 并隐藏

### 4. 云函数支持

#### `getJointGoods` 云函数
```javascript
exports.main = async (event, context) => {
  try {
    const { projectId } = event;
    if (!projectId) {
      return {
        success: false,
        message: '项目ID不能为空'
      };
    }
    
    const res = await db.collection('joint_projects').doc(projectId).get();
    if (res.data && res.data.length > 0) {
      const goods = Array.isArray(res.data[0].goods) ? res.data[0].goods : [];
      return {
        success: true,
        data: goods
      };
    } else {
      return {
        success: false,
        message: '未找到该项目'
      };
    }
  } catch (error) {
    console.error('获取合坛法会代办物品失败:', error);
    return {
      success: false,
      message: '获取代办物品失败: ' + (error.message || error)
    };
  }
};
```

#### 其他相关云函数
- `addJointGood` - 添加代办物品
- `updateJointGood` - 更新代办物品
- `deleteJointGood` - 删除代办物品

### 5. 数据结构

#### 项目数据结构
```javascript
{
  _id: "project_id",
  name: "项目名称",
  price: 200,
  description: "项目描述",
  category: "平安祈福",
  deadline: "2025-12-31",
  dates: ["2025-08-01", "2025-08-15"],
  maxApplicants: 100,
  goods: [
    {
      name: "香烛",
      price: 50,
      description: "上等香烛"
    },
    {
      name: "供果",
      price: 30,
      description: "新鲜供果"
    }
  ]
}
```

#### 前台代办物品数据结构
```javascript
{
  name: "香烛",
  price: 50,
  description: "上等香烛",
  count: 0  // 用户选择的数量
}
```

### 6. 用户体验

#### 动态显示
- 选择项目后立即加载并显示该项目的代办物品
- 如果项目没有设置代办物品，则不显示代办物品模块
- 切换项目时自动更新代办物品列表

#### 用户操作
- 用户可以选择代办物品的数量
- 数量默认为0，用户可以根据需要调整
- 选择的数量会保存到本地草稿中

#### 费用计算
- 代办物品费用 = 物品单价 × 选择数量
- 在确认页面显示代办费用明细
- 在支付页面显示总费用（活动费用 + 代办费用）

### 7. 错误处理

#### 加载失败处理
```javascript
catch (error) {
  console.error('加载代办物品配置失败:', error)
  this.showItems = false
  this.items = []
}
```

#### 数据验证
- 检查项目ID是否存在
- 验证代办物品数据格式
- 确保价格为正数

### 8. 总结

代办物品模块完全按照需求实现：

✅ **后台设置**：管理员可以为每个项目设置代办物品（名称、单价）
✅ **前台显示**：只有后台设置了代办物品的项目才在前台显示代办物品模块
✅ **动态加载**：选择项目后自动加载对应的代办物品
✅ **用户选择**：用户可以选择物品数量
✅ **费用计算**：正确计算代办物品费用
✅ **数据一致性**：前后台数据完全同步

这样的实现确保了：
- 管理员可以灵活控制哪些项目显示代办物品
- 用户界面简洁，不会显示空的代办物品模块
- 数据流程清晰，从后台设置到前台显示完全自动化 