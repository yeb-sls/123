# 合坛法会订单管理系统 - 云函数上传指南

## 需要上传的云函数

### 1. joint-management (云对象)
**路径**: `uniCloud-aliyun/cloudfunctions/joint-management/`
**功能**: 合坛法会上传管理云对象，包含订单管理、项目管理、物品管理等功能

**主要方法**:
- `getOrders()` - 获取订单列表
- `updateOrderStatus()` - 更新订单状态
- `confirmFahuiDate()` - 确认合坛法会日期
- `addOrderRemark()` - 添加订单备注
- `deleteOrder()` - 删除订单
- `sendAdminNotification()` - 发送管理员通知
- `getAdminNotifications()` - 获取管理员通知
- `getUnreadNotificationCount()` - 获取未读通知数量
- `exportOrders()` - 导出订单

### 2. notifyAdminOnPayment
**路径**: `uniCloud-aliyun/cloudfunctions/notifyAdminOnPayment/`
**功能**: 支付成功后自动发送通知给管理员

**触发时机**: 合坛法会订单支付成功后
**功能**: 
- 创建管理员通知记录
- 更新订单状态为待确认
- 记录支付时间

### 3. exportJointOrders
**路径**: `uniCloud-aliyun/cloudfunctions/exportJointOrders/`
**功能**: 专门用于导出合坛法会订单数据

**功能**:
- 支持按状态、项目筛选
- 支持按时间范围筛选
- 生成完整的CSV格式数据
- 包含所有订单详细信息

### 4. notification-system (云对象)
**路径**: `uniCloud-aliyun/cloudfunctions/notification-system/`
**功能**: 通知系统云对象，管理所有通知相关功能

**主要方法**:
- `getUnreadCount()` - 获取未读通知数量
- `getNotifications()` - 获取通知列表
- `markAsRead()` - 标记通知为已读
- `markAllAsRead()` - 标记所有通知为已读
- `createNotification()` - 创建通知

## 上传步骤

### 1. 上传 joint-management 云对象
1. 在HBuilderX中右键点击 `uniCloud-aliyun/cloudfunctions/joint-management/` 文件夹
2. 选择"上传部署"
3. 等待上传完成

### 2. 上传 notifyAdminOnPayment 云函数
1. 在HBuilderX中右键点击 `uniCloud-aliyun/cloudfunctions/notifyAdminOnPayment/` 文件夹
2. 选择"上传部署"
3. 等待上传完成

### 3. 上传 exportJointOrders 云函数
1. 在HBuilderX中右键点击 `uniCloud-aliyun/cloudfunctions/exportJointOrders/` 文件夹
2. 选择"上传部署"
3. 等待上传完成

### 4. 上传 notification-system 云对象
1. 在HBuilderX中右键点击 `uniCloud-aliyun/cloudfunctions/notification-system/` 文件夹
2. 选择"上传部署"
3. 等待上传完成

## 功能说明

### 订单管理功能
1. **查询订单**: 支持按状态、项目筛选订单
2. **订单确认**: 管理员可以确认合坛法会，系统自动记录操作人和操作时间
3. **添加备注**: 管理员可以为订单添加备注，系统自动记录操作人和操作时间
4. **导出订单**: 支持导出完整的订单数据为CSV格式

### 通知功能
1. **支付成功通知**: 订单支付成功后自动发送通知给管理员
2. **确认通知**: 合坛法会确认后发送通知
3. **备注通知**: 添加备注后发送通知
4. **未读通知计数**: 实时显示未读通知数量

### 操作日志
1. **状态变更日志**: 记录所有订单状态变更
2. **确认操作日志**: 记录合坛法会确认操作
3. **备注操作日志**: 记录备注添加操作
4. **操作人记录**: 所有操作都记录操作人姓名

## 数据库集合

### admin_notifications
管理员通知集合，存储所有系统通知

### joint_orders
合坛法会订单集合，存储所有订单信息

### joint_projects
合坛法会项目集合，存储项目信息

### joint_goods
合坛法会物品集合，存储物品信息

## 注意事项

1. 确保所有云函数都已正确上传
2. 检查数据库权限设置
3. 测试支付成功后的通知功能
4. 测试订单确认和备注功能
5. 测试导出功能

## 测试建议

1. **支付流程测试**: 完成一个完整的合坛法会报名和支付流程
2. **通知测试**: 检查支付成功后是否收到通知
3. **确认测试**: 测试订单确认功能，检查操作日志
4. **备注测试**: 测试添加备注功能，检查备注记录
5. **导出测试**: 测试导出功能，检查CSV数据完整性 