# 前端调用更新指南

## 概述

本指南将帮助你将所有前端代码中的云函数调用更新为云对象调用，以配合云对象重构方案。

## 云对象导入方式

### 1. 通知系统云对象
```javascript
const notificationSystem = uniCloud.importObject('notification-system')
```

### 2. 合坛法会管理云对象
```javascript
const jointManagement = uniCloud.importObject('joint-management')
```

### 3. 专场法会管理云对象
```javascript
const fahuiManagement = uniCloud.importObject('fahui-management')
```

### 4. 通用管理云对象
```javascript
const commonManagement = uniCloud.importObject('common-management')
```

## 调用方式对比

### 旧方式：云函数调用
```javascript
// 获取未读通知数量
const result = await uniCloud.callFunction({
  name: 'getUnreadNotificationCount'
})
this.unreadCount = result.result.count || 0
```

### 新方式：云对象调用
```javascript
// 获取未读通知数量
const result = await notificationSystem.getUnreadCount()
if (result.success) {
  this.unreadCount = result.count || 0
}
```

## 具体更新示例

### 1. 通知系统相关页面

#### pages/admin/index.vue
```javascript
// 旧代码
async loadUnreadCount() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getUnreadNotificationCount'
    })
    this.unreadCount = result.result.count || 0
  } catch (error) {
    console.error('加载未读通知数量失败:', error)
  }
}

// 新代码
const notificationSystem = uniCloud.importObject('notification-system')

async loadUnreadCount() {
  try {
    const result = await notificationSystem.getUnreadCount()
    if (result.success) {
      this.unreadCount = result.count || 0
    }
  } catch (error) {
    console.error('加载未读通知数量失败:', error)
  }
}
```

#### pages/admin/notifications.vue
```javascript
// 旧代码
async loadNotifications() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getAdminNotifications'
    })
    this.notifications = result.result.data || []
  } catch (error) {
    console.error('加载通知失败:', error)
  }
}

async markAsRead(notificationId) {
  try {
    await uniCloud.callFunction({
      name: 'markNotificationAsRead',
      data: { notificationId }
    })
    this.loadNotifications()
  } catch (error) {
    console.error('标记已读失败:', error)
  }
}

// 新代码
const notificationSystem = uniCloud.importObject('notification-system')

async loadNotifications() {
  try {
    const result = await notificationSystem.getNotifications()
    if (result.success) {
      this.notifications = result.data || []
    }
  } catch (error) {
    console.error('加载通知失败:', error)
  }
}

async markAsRead(notificationId) {
  try {
    const result = await notificationSystem.markAsRead({ notificationId })
    if (result.success) {
      uni.showToast({ title: '已标记为已读', icon: 'success' })
      this.loadNotifications()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('标记已读失败:', error)
    uni.showToast({ title: '操作失败', icon: 'none' })
  }
}
```

### 2. 合坛法会相关页面

#### pages/admin/joint/projects.vue
```javascript
// 旧代码
async loadProjects() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getJointProjects'
    })
    this.projects = result.result.data || []
  } catch (error) {
    console.error('加载项目失败:', error)
  }
}

async addProject(projectData) {
  try {
    await uniCloud.callFunction({
      name: 'addJointProject',
      data: projectData
    })
    uni.showToast({ title: '添加成功', icon: 'success' })
    this.loadProjects()
  } catch (error) {
    console.error('添加项目失败:', error)
  }
}

// 新代码
const jointManagement = uniCloud.importObject('joint-management')

async loadProjects() {
  try {
    const result = await jointManagement.getProjects()
    if (result.success) {
      this.projects = result.data || []
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('加载项目失败:', error)
    uni.showToast({ title: '加载失败', icon: 'none' })
  }
}

async addProject(projectData) {
  try {
    const result = await jointManagement.addProject(projectData)
    if (result.success) {
      uni.showToast({ title: '添加成功', icon: 'success' })
      this.loadProjects()
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('添加项目失败:', error)
    uni.showToast({ title: '添加失败', icon: 'none' })
  }
}
```

#### pages/admin/joint/orders.vue
```javascript
// 旧代码
async loadOrders() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getJointOrders'
    })
    this.orders = result.result.data || []
  } catch (error) {
    console.error('加载订单失败:', error)
  }
}

async exportOrders() {
  try {
    const result = await uniCloud.callFunction({
      name: 'exportJointOrders'
    })
    // 处理导出逻辑
  } catch (error) {
    console.error('导出订单失败:', error)
  }
}

// 新代码
const jointManagement = uniCloud.importObject('joint-management')

async loadOrders() {
  try {
    const result = await jointManagement.getOrders()
    if (result.success) {
      this.orders = result.data || []
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('加载订单失败:', error)
    uni.showToast({ title: '加载失败', icon: 'none' })
  }
}

async exportOrders() {
  try {
    uni.showLoading({ title: '正在导出...' })
    const result = await jointManagement.exportOrders()
    if (result.success) {
      // 处理导出逻辑
      const csvContent = this.generateCSV(result.data)
      uni.setClipboardData({
        data: csvContent,
        success: () => {
          uni.hideLoading()
          uni.showModal({
            title: '导出成功',
            content: '订单数据已复制到剪贴板，请粘贴到Excel中查看',
            showCancel: false
          })
        }
      })
    } else {
      uni.hideLoading()
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    uni.hideLoading()
    console.error('导出订单失败:', error)
    uni.showToast({ title: '导出失败', icon: 'none' })
  }
}
```

### 3. 专场法会相关页面

#### pages/admin/fahui/projects.vue
```javascript
// 旧代码
async loadProjects() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getFahuiProjects'
    })
    this.projects = result.result.data || []
  } catch (error) {
    console.error('加载项目失败:', error)
  }
}

// 新代码
const fahuiManagement = uniCloud.importObject('fahui-management')

async loadProjects() {
  try {
    const result = await fahuiManagement.getProjects()
    if (result.success) {
      this.projects = result.data || []
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('加载项目失败:', error)
    uni.showToast({ title: '加载失败', icon: 'none' })
  }
}
```

### 4. 通用管理相关页面

#### pages/admin/home/banner.vue
```javascript
// 旧代码
async loadBanners() {
  try {
    const result = await uniCloud.callFunction({
      name: 'getHomeBanners'
    })
    this.banners = result.result.data || []
  } catch (error) {
    console.error('加载横幅失败:', error)
  }
}

// 新代码
const commonManagement = uniCloud.importObject('common-management')

async loadBanners() {
  try {
    const result = await commonManagement.getHomeBanners()
    if (result.success) {
      this.banners = result.data || []
    } else {
      uni.showToast({ title: result.message, icon: 'none' })
    }
  } catch (error) {
    console.error('加载横幅失败:', error)
    uni.showToast({ title: '加载失败', icon: 'none' })
  }
}
```

## 更新步骤

### 步骤1：导入云对象
在每个需要使用的页面顶部添加云对象导入：

```javascript
// 在 script 标签开始处添加
const notificationSystem = uniCloud.importObject('notification-system')
const jointManagement = uniCloud.importObject('joint-management')
const fahuiManagement = uniCloud.importObject('fahui-management')
const commonManagement = uniCloud.importObject('common-management')
```

### 步骤2：更新方法调用
将所有的 `uniCloud.callFunction` 调用替换为对应的云对象方法调用。

### 步骤3：更新错误处理
云对象返回的结果格式为 `{ success: boolean, data: any, message: string }`，需要相应调整错误处理逻辑。

### 步骤4：测试功能
更新完成后，测试所有功能是否正常工作。

## 注意事项

1. **云对象导入位置**：建议在 `script` 标签开始处导入，确保全局可用
2. **错误处理**：云对象返回的结果包含 `success` 字段，需要检查该字段
3. **参数传递**：云对象方法直接接收参数，不需要包装在 `data` 字段中
4. **返回值处理**：云对象返回的数据在 `result.data` 中，而不是 `result.result.data`
5. **异步处理**：云对象调用仍然是异步的，需要使用 `async/await`

## 批量更新建议

1. **按模块更新**：先更新通知系统，再更新合坛法会，最后更新其他模块
2. **测试验证**：每个模块更新后都要测试功能
3. **备份代码**：更新前备份原始代码
4. **文档记录**：记录更新的页面和方法

## 常见问题

### Q: 云对象调用失败怎么办？
A: 检查云对象是否已正确上传，确保云对象名称正确。

### Q: 返回数据格式不同怎么办？
A: 云对象返回的数据在 `result.data` 中，需要相应调整代码。

### Q: 如何调试云对象调用？
A: 使用 `console.log` 输出云对象返回的结果，检查 `success` 字段和错误信息。

按照这个指南逐步更新前端代码，可以顺利完成从云函数到云对象的迁移。 